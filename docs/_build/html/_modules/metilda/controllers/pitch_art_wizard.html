<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>metilda.controllers.pitch_art_wizard &mdash; MeTILDA 1.0.0v documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=838d9f6d"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MeTILDA
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../metilda.controllers.html">metilda.controllers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metilda.services.html">metilda.services package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MeTILDA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../metilda.html">metilda</a></li>
      <li class="breadcrumb-item active">metilda.controllers.pitch_art_wizard</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for metilda.controllers.pitch_art_wizard</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">.Postgres</span> <span class="kn">import</span> <span class="n">Postgres</span>
<span class="kn">from</span> <span class="nn">metilda</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">metilda.default</span> <span class="kn">import</span> <span class="n">MIN_PITCH_HZ</span><span class="p">,</span> <span class="n">MAX_PITCH_HZ</span>
<span class="kn">from</span> <span class="nn">metilda.services</span> <span class="kn">import</span> <span class="n">audio_analysis</span><span class="p">,</span> <span class="n">file_io</span><span class="p">,</span> <span class="n">praat</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">import</span> <span class="nn">firebase_admin</span>
<span class="kn">from</span> <span class="nn">firebase_admin</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">auth</span>
<span class="kn">import</span> <span class="nn">wave</span>
<span class="kn">import</span> <span class="nn">pympi</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">lxml.etree</span> <span class="k">as</span> <span class="nn">etree</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wav&#39;</span><span class="p">,</span> <span class="s1">&#39;mp3&#39;</span><span class="p">,</span> <span class="s1">&#39;mpeg&#39;</span><span class="p">}</span>
<div class="viewcode-block" id="allowed_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.allowed_file">[docs]</a><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span></div>

<div class="viewcode-block" id="api"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.api">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;MetildaAPI&quot;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">})</span></div>

<div class="viewcode-block" id="audio_analysis_image"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.audio_analysis_image">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio/&lt;string:upload_id&gt;.png/image&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">audio_analysis_image</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">upload_id</span><span class="p">)</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmin&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmax&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">min_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min-pitch&#39;</span><span class="p">,</span> <span class="n">MIN_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">max_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max-pitch&#39;</span><span class="p">,</span> <span class="n">MAX_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">image_binary</span> <span class="o">=</span> <span class="n">audio_analysis</span><span class="o">.</span><span class="n">audio_analysis_image</span><span class="p">(</span>
        <span class="n">image_path</span><span class="p">,</span>
        <span class="n">min_pitch</span><span class="o">=</span><span class="n">min_pitch</span><span class="p">,</span>
        <span class="n">max_pitch</span><span class="o">=</span><span class="n">max_pitch</span><span class="p">,</span>
        <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span>
        <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">image_binary</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="audio"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.audio">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio/&lt;string:upload_id&gt;/file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">audio</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">upload_id</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">:</span>
        <span class="c1"># This is the case when the page load and a file has</span>
        <span class="c1"># not been selected</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">204</span>

    <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">upload_id</span><span class="p">)</span>
    <span class="n">tmin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmin&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tmax&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">file_bytes</span> <span class="o">=</span> <span class="n">audio_analysis</span><span class="o">.</span><span class="n">get_audio</span><span class="p">(</span><span class="n">sound_path</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">file_bytes</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;audio/wav&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="avg_pitch"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.avg_pitch">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio/&lt;string:upload_id&gt;/pitch/avg&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">avg_pitch</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">upload_id</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">max_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max-pitch&#39;</span><span class="p">,</span> <span class="n">MAX_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">min_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min-pitch&#39;</span><span class="p">,</span> <span class="n">MIN_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">audio_analysis</span><span class="o">.</span><span class="n">get_avg_pitch</span><span class="p">((</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">),</span> <span class="n">sound_path</span><span class="p">,</span> <span class="n">min_pitch</span><span class="p">,</span> <span class="n">max_pitch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;avg_pitch&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span></div>


<div class="viewcode-block" id="all_audio_pitches"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.all_audio_pitches">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio/&lt;string:upload_id&gt;/pitch/range&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">all_audio_pitches</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="n">max_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max-pitch&#39;</span><span class="p">,</span> <span class="n">MAX_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">min_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min-pitch&#39;</span><span class="p">,</span> <span class="n">MIN_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">upload_id</span><span class="p">)</span>
    <span class="n">pitches</span> <span class="o">=</span> <span class="n">audio_analysis</span><span class="o">.</span><span class="n">get_all_pitches</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">],</span> <span class="n">sound_path</span><span class="p">,</span> <span class="n">min_pitch</span><span class="p">,</span> <span class="n">max_pitch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;pitches&#39;</span><span class="p">:</span> <span class="n">pitches</span><span class="p">})</span></div>


<div class="viewcode-block" id="all_upload_pitches"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.all_upload_pitches">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/upload/pitch/range&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">all_upload_pitches</span><span class="p">():</span>
    <span class="n">max_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max-pitch&#39;</span><span class="p">,</span> <span class="n">MAX_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">min_pitch</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min-pitch&#39;</span><span class="p">,</span> <span class="n">MIN_PITCH_HZ</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">audio_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
    <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;audio.wav&quot;</span><span class="p">)</span>
    <span class="n">audio_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sound_path</span><span class="p">)</span>

    <span class="n">pitches</span> <span class="o">=</span> <span class="n">audio_analysis</span><span class="o">.</span><span class="n">get_all_pitches</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">],</span> <span class="n">sound_path</span><span class="p">,</span> <span class="n">min_pitch</span><span class="p">,</span> <span class="n">max_pitch</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;pitches&#39;</span><span class="p">:</span> <span class="n">pitches</span><span class="p">})</span></div>


<div class="viewcode-block" id="sound_length"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.sound_length">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio/&lt;string:upload_id&gt;/duration&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">sound_length</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">upload_id</span><span class="p">)</span>
    <span class="n">sound_length</span> <span class="o">=</span> <span class="n">audio_analysis</span><span class="o">.</span><span class="n">get_sound_length</span><span class="p">(</span><span class="n">sound_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">sound_length</span><span class="p">})</span></div>

<div class="viewcode-block" id="download_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.download_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio/download-file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">download_file</span><span class="p">():</span> 
    <span class="n">file</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;No selected file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="c1"># filename = secure_filename(file.filename)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sound_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">})</span></div>


<div class="viewcode-block" id="available_files"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.available_files">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/audio&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">available_files</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">file_io</span><span class="o">.</span><span class="n">available_files</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">])})</span></div>


<div class="viewcode-block" id="create_db_user"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_db_user">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_db_user</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO users (USER_ID, USER_NAME, UNIVERSITY,</span>
<span class="s2">        CREATED_AT, LAST_LOGIN) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) RETURNING USER_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;university&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="create_user_research_language"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_user_research_language">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-user-research-language&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_user_research_language</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO user_research_language (USER_ID, USER_LANGUAGE) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) RETURNING USER_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="create_user_research_role"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_user_research_role">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-user-role&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_user_research_role</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO user_role (USER_ID, USER_ROLE) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) RETURNING USER_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_role&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="update_db_user"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.update_db_user">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/update-user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_db_user</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE users</span>
<span class="s2">                SET last_login = CURRENT_TIMESTAMP</span>
<span class="s2">                WHERE user_id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">})</span></div>

<div class="viewcode-block" id="create_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_file</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO audio (AUDIO_ID, USER_ID, FILE_NAME, FILE_PATH, FILE_TYPE, FILE_SIZE,</span>
<span class="s2">         CREATED_AT, UPDATED_AT) VALUES (DEFAULT,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) RETURNING AUDIO_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">],</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_type&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>

        <span class="n">postgres_insert_audio_user</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO audio_user(AUDIO_ID, USER_ID, PERMISSION) VALUES( </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">) &quot;&quot;&quot;</span>
        <span class="n">insert_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_row_id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="s2">&quot;own&quot;</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_audio_user</span><span class="p">,</span> <span class="n">insert_values</span><span class="p">,</span> <span class="n">need_last_row_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Recording&#39;</span><span class="p">:</span>
            <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO recording_info (AUDIO_ID, NUMBER_OF_SYLLABLES, RECORDING_NAME) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) RETURNING AUDIO_ID&quot;&quot;&quot;</span>
            <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_row_id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;number_of_syllables&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;recording_word_name&#39;</span><span class="p">])</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>


<div class="viewcode-block" id="move_to_folder"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.move_to_folder">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/move-to-folder&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">move_to_folder</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_update_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE audio </span>
<span class="s2">            SET FILE_PATH = </span><span class="si">%s</span>
<span class="s2">            WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">record_to_update</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_id&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_update_query</span><span class="p">,</span> <span class="n">record_to_update</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="create_folder"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_folder">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-folder&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_folder</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO audio (AUDIO_ID, USER_ID, FILE_NAME, FILE_PATH, FILE_TYPE, FILE_SIZE,</span>
<span class="s2">         CREATED_AT, UPDATED_AT) VALUES (DEFAULT,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) RETURNING AUDIO_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">],</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_type&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
        <span class="n">postgres_insert_audio_user</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO audio_user(AUDIO_ID, USER_ID, PERMISSION) VALUES( </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">) &quot;&quot;&quot;</span>
        <span class="n">insert_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_row_id</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="s2">&quot;own&quot;</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_audio_user</span><span class="p">,</span> <span class="n">insert_values</span><span class="p">,</span> <span class="n">need_last_row_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="share_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.share_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/share-file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">share_file</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_audio_user</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO audio_user(AUDIO_ID, USER_ID, PERMISSION) VALUES( </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">) &quot;&quot;&quot;</span>
        <span class="n">insert_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;audio_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;permission&#39;</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_audio_user</span><span class="p">,</span> <span class="n">insert_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_file</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM audio WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_id&#39;</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_eaf_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_eaf_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-eaf-file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_eaf_file</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM eaf WHERE EAF_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;eaf_id&#39;</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_shared_user"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_shared_user">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-shared-user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_shared_user</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM audio_user WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2"> AND USER_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;audio_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="p">))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_folder"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_folder">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-folder&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_folder</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_delete_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM audio WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_delete_query</span><span class="p">,</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_id&#39;</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_image"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_image">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-image&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_image</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM image WHERE IMAGE_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">],))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_recording"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_recording">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-recording&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_recording</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM audio WHERE USER_ID = </span><span class="si">%s</span><span class="s2"> AND FILE_PATH LIKE </span><span class="si">%s</span><span class="s2"> AND FILE_TYPE= </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">record_to_delete</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="s2">&quot;%&quot;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_type&#39;</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="n">record_to_delete</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-files/&lt;string:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">file_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file-type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT x.audio_id, x.file_name, x.file_path, x.file_size, x.file_type, x.created_at, x.updated_at, y.user_id, y.permission </span>
<span class="s2">        FROM audio AS x, audio_user AS y </span>
<span class="s2">        WHERE x.audio_id = y.audio_id </span>
<span class="s2">        AND y.USER_ID = </span><span class="si">%s</span><span class="s2"> AND FILE_TYPE = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="n">filter_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_files_and_folders"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_files_and_folders">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-files-and-folders/&lt;string:user_id&gt;/&lt;string:folder_name&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_files_and_folders</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
    <span class="n">file_type1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file-type1&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">file_type2</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file-type2&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">filteredResults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT x.audio_id, x.file_name, x.file_path, x.file_size, x.file_type, x.created_at, x.updated_at, y.user_id, y.permission </span>
<span class="s2">        FROM audio AS x, audio_user AS y </span>
<span class="s2">        WHERE x.audio_id = y.audio_id </span>
<span class="s2">        AND y.user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">        AND (x.FILE_TYPE = </span><span class="si">%s</span><span class="s2"> OR x.FILE_TYPE = </span><span class="si">%s</span><span class="s2">) </span>
<span class="s2">        AND x.FILE_PATH LIKE </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">folder_name</span> <span class="o">!=</span> <span class="s1">&#39;Uploads&#39;</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;%/Uploads/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/%&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;%/Uploads/%&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">file_type1</span><span class="p">,</span> <span class="n">file_type2</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="n">filter_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">folder_name</span> <span class="o">==</span> <span class="s1">&#39;Uploads&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">forwardSlashCounter</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">forwardSlashCounter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">filteredResults</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">filteredResults</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_shared_users"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_shared_users">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-shared-users/&lt;audio_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_shared_users</span><span class="p">(</span><span class="n">audio_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * from audio_user WHERE audio_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">filter_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_values</span><span class="p">,))</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>



<div class="viewcode-block" id="get_eaf_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_eaf_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-eaf-files/&lt;string:audio_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_eaf_file</span><span class="p">(</span><span class="n">audio_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT EAF_ID, EAF_FILE_NAME FROM eaf WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">audio_id</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_eaf_file_path"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_eaf_file_path">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-eaf-file-path/&lt;string:eaf_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_eaf_file_path</span><span class="p">(</span><span class="n">eaf_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT EAF_FILE_PATH FROM eaf WHERE EAF_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">eaf_id</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span></div>

<div class="viewcode-block" id="get_eafs_for_files"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_eafs_for_files">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-eafs-for-files/&lt;string:audio_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_eafs_for_files</span><span class="p">(</span><span class="n">audio_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM eaf WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">audio_id</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_analysis_file_path"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_analysis_file_path">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-analysis-file-path/&lt;string:analysis_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_analysis_file_path</span><span class="p">(</span><span class="n">analysis_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT ANALYSIS_FILE_PATH FROM analysis WHERE ANALYSIS_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">analysis_id</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span></div>

<div class="viewcode-block" id="create_analysis"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_analysis">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-analysis&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_analysis</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO analysis (ANALYSIS_ID, AUDIO_ID, ANALYSIS_FILE_NAME, ANALYSIS_FILE_PATH, GENERATED_AT, UPDATED_AT) VALUES (DEFAULT,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) RETURNING ANALYSIS_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;analysis_file_name&#39;</span><span class="p">],</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;analysis_file_path&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="create_eaf"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_eaf">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-eaf&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_eaf</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO eaf (EAF_ID, AUDIO_ID, EAF_FILE_NAME, EAF_FILE_PATH, GENERATED_AT, UPDATED_AT) VALUES (DEFAULT,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) RETURNING EAF_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;file_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;eaf_file_name&#39;</span><span class="p">],</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;eaf_file_path&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="update_analysis"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.update_analysis">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/update-analysis&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_analysis</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE analysis SET ANALYSIS_FILE_PATH=</span><span class="si">%s</span><span class="s2">, UPDATED_AT=CURRENT_TIMESTAMP WHERE ANALYSIS_ID=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;analysis_file_path&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;analysis_id&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="create_image"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.create_image">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-image&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_image</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO image (IMAGE_ID, IMAGE_NAME, IMAGE_PATH, USER_ID, CREATED_AT) VALUES (DEFAULT,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">, CURRENT_TIMESTAMP) RETURNING IMAGE_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;image_name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;image_path&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="insert_image_analysis_ids"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.insert_image_analysis_ids">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/create-image-analysis&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">insert_image_analysis_ids</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO image_analysis (IMAGE_ID, ANALYSIS_ID) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) RETURNING ANALYSIS_ID&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;analysis_id&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_analyses_for_file"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_analyses_for_file">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-analyses-for-file/&lt;string:file_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_analyses_for_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM analysis WHERE AUDIO_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="n">file_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_image_for_analysis"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_image_for_analysis">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-image-for-analysis/&lt;string:analysis_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_image_for_analysis</span><span class="p">(</span><span class="n">analysis_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT IMAGE.* FROM IMAGE, IMAGE_ANALYSIS WHERE IMAGE_ANALYSIS.ANALYSIS_ID = </span><span class="si">%s</span><span class="s2"> AND IMAGE.IMAGE_ID=IMAGE_ANALYSIS.IMAGE_ID&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="n">analysis_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_all_images"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_all_images">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-all-images-for-user/&lt;string:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_all_images</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM IMAGE WHERE IMAGE_PATH LIKE </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="o">+</span><span class="n">user_id</span><span class="o">+</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_analyses_for_image"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_analyses_for_image">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-analyses-for-image/&lt;string:image_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_analyses_for_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT ANALYSIS.* FROM ANALYSIS, IMAGE_ANALYSIS WHERE IMAGE_ANALYSIS.IMAGE_ID = </span><span class="si">%s</span><span class="s2"> AND ANALYSIS.ANALYSIS_ID=IMAGE_ANALYSIS.ANALYSIS_ID&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_student_recordings"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_student_recordings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-all-students&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_student_recordings</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT USERS.USER_NAME, USERS.USER_ID,USERS.LAST_LOGIN FROM USERS, USER_ROLE WHERE USER_ROLE= </span><span class="si">%s</span><span class="s2"> AND USERS.USER_ID=USER_ROLE.USER_ID&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_admin"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_admin">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-user-with-verified-role/&lt;string:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user_role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user-role&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM USER_ROLE WHERE USER_ROLE= </span><span class="si">%s</span><span class="s2"> AND USER_ID=</span><span class="si">%s</span><span class="s2"> AND VERIFIED = true&quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span> <span class="p">(</span><span class="n">user_role</span><span class="p">,</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="n">filter_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_users"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_users">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_users</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM USERS &quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_user_roles"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_user_roles">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-user-roles/&lt;string:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_user_roles</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT USER_ROLE FROM USER_ROLE WHERE USER_ID = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>


<div class="viewcode-block" id="get_user_research_language"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.get_user_research_language">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/get-user-research-language/&lt;string:user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_user_research_language</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT USER_LANGUAGE FROM USER_RESEARCH_LANGUAGE WHERE USER_ID = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_user"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_user">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_user</span><span class="p">():</span>
    <span class="n">user_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
    <span class="c1"># Delete user from firebase</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">firebase_admin</span><span class="o">.</span><span class="n">_apps</span><span class="p">)):</span>
        <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;CERTIFICATES&quot;</span><span class="p">],</span> <span class="s2">&quot;serviceAccountKey.json&quot;</span><span class="p">)</span>
        <span class="n">service_account_credential</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">Certificate</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">)</span>
        <span class="n">firebase_admin</span><span class="o">.</span><span class="n">initialize_app</span><span class="p">(</span><span class="n">service_account_credential</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully deleted user from firebase&#39;</span><span class="p">)</span>
    <span class="c1"># Delete user from DB</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM USERS WHERE USER_ID = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">filter_values</span><span class="o">=</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,(</span><span class="n">filter_values</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="add_new_user_from_admin"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.add_new_user_from_admin">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/add-new-user-from-admin&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_new_user_from_admin</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">firebase_admin</span><span class="o">.</span><span class="n">_apps</span><span class="p">)):</span>
        <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;CERTIFICATES&quot;</span><span class="p">],</span> <span class="s2">&quot;serviceAccountKey.json&quot;</span><span class="p">)</span>
        <span class="n">service_account_credential</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">Certificate</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">)</span>
        <span class="n">firebase_admin</span><span class="o">.</span><span class="n">initialize_app</span><span class="p">(</span><span class="n">service_account_credential</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Insert user into firebase</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="n">password</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Sucessfully created new user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="p">)))</span>
        <span class="c1"># Insert user into DB</span>
        <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO users (USER_ID, USER_NAME, UNIVERSITY,</span>
<span class="s2">            CREATED_AT, LAST_LOGIN) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) RETURNING USER_ID&quot;&quot;&quot;</span>
            <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;university&#39;</span><span class="p">])</span>
            <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_row_id</span><span class="p">)})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span></div>

<div class="viewcode-block" id="update_user_from_admin"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.update_user_from_admin">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/update-user-from-admin&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_user_from_admin</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">firebase_admin</span><span class="o">.</span><span class="n">_apps</span><span class="p">)):</span>
        <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;CERTIFICATES&quot;</span><span class="p">],</span> <span class="s2">&quot;serviceAccountKey.json&quot;</span><span class="p">)</span>
        <span class="n">service_account_credential</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">Certificate</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">)</span>
        <span class="n">firebase_admin</span><span class="o">.</span><span class="n">initialize_app</span><span class="p">(</span><span class="n">service_account_credential</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Update user in firebase</span>
        <span class="n">previous_email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;previous_email&#39;</span><span class="p">]</span>
        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        <span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">]</span>
        <span class="n">university</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;university&#39;</span><span class="p">]</span>
        <span class="n">password</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">previous_email</span><span class="p">)</span><span class="o">.</span><span class="n">uid</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span>
        <span class="n">uid</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Sucessfully updated new user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">uid</span><span class="p">)))</span>
        <span class="c1"># Update user in DB</span>
        <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE users SET USER_ID=</span><span class="si">%s</span><span class="s2">,USER_NAME=</span><span class="si">%s</span><span class="s2">, UNIVERSITY=</span><span class="si">%s</span><span class="s2"> WHERE USER_ID = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">university</span><span class="p">,</span> <span class="n">previous_email</span><span class="p">)</span>
            <span class="n">last_row_id</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_row_id</span><span class="p">)})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span></div>

<div class="viewcode-block" id="delete_previous_user_roles"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_previous_user_roles">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-previous-user-roles&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_previous_user_roles</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM user_role WHERE USER_ID = </span><span class="si">%s</span><span class="s2"> AND USER_ROLE=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">record_to_delete</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_role&#39;</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="n">record_to_delete</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="delete_previous_user_research_language"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.delete_previous_user_research_language">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/delete-previous-user-research-language&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_previous_user_research_language</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM user_research_language WHERE USER_ID = </span><span class="si">%s</span><span class="s2"> AND USER_LANGUAGE=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">record_to_delete</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="n">record_to_delete</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>

<div class="viewcode-block" id="authorize_user"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.authorize_user">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/authorize-user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">authorize_user</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">postgres_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE user_role SET VERIFIED = true WHERE USER_ID=</span><span class="si">%s</span><span class="s2"> AND USER_ROLE=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">record_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user_role&#39;</span><span class="p">])</span>
        <span class="n">last_row_id</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_insert_query</span><span class="p">,</span> <span class="n">record_to_insert</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">last_row_id</span><span class="p">})</span></div>


<div class="viewcode-block" id="modifyPitchOrImageDetails"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.modifyPitchOrImageDetails">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/words/&lt;string:upload_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PATCH&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">modifyPitchOrImageDetails</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="n">req_method</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span>

    <span class="k">if</span> <span class="n">req_method</span> <span class="o">==</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT id FROM word WHERE id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">select_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">upload_id</span><span class="p">,))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">select_results</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;isSuccessful&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;Word does not exist&quot;</span><span class="p">}),</span> <span class="mi">404</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
                <span class="n">no_valid_fields_provided</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;minPitch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">body</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;maxPitch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">body</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="s2">&quot;imagePath&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">body</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span> <span class="ow">or</span> <span class="n">no_valid_fields_provided</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;isSuccessful&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;Valid body not provided&quot;</span><span class="p">}),</span> <span class="mi">400</span>

                <span class="n">postgres_update_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE word&quot;&quot;&quot;</span>

                <span class="n">valid_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;minPitch&quot;</span><span class="p">:</span> <span class="s2">&quot;min_pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;maxPitch&quot;</span><span class="p">:</span> <span class="s2">&quot;max_pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;imagePath&quot;</span><span class="p">:</span> <span class="s2">&quot;image_path&quot;</span><span class="p">}</span>
                <span class="n">record_to_update</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">set_appended</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">valid_fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_appended</span><span class="p">:</span>
                            <span class="n">postgres_update_query</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot; SET &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">valid_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
                            <span class="n">set_appended</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">postgres_update_query</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">valid_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>

                        <span class="n">record_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>

                <span class="n">postgres_update_query</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot; WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
                <span class="n">record_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upload_id</span><span class="p">)</span>

                <span class="n">record_to_update</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">record_to_update</span><span class="p">)</span>

                <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_update_query</span><span class="p">,</span> <span class="n">record_to_update</span><span class="p">)</span>

                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;isSuccessful&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">valid_fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                        <span class="n">response</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">req_method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">postgres_select_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT id FROM word WHERE id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">select_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">postgres_select_query</span><span class="p">,</span> <span class="p">(</span><span class="n">upload_id</span><span class="p">,))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">select_results</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;isSuccessful&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;Word does not exist for purposes of deletion&quot;</span><span class="p">}),</span> <span class="mi">404</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">postgres_delete_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; DELETE FROM word WHERE id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
                <span class="n">word_to_delete</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">upload_id</span><span class="p">))</span>

                <span class="n">connection</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">postgres_delete_query</span><span class="p">,</span> <span class="p">(</span><span class="n">upload_id</span><span class="p">,))</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;isSuccessful&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;wordDeleted&#39;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">})</span></div>

<span class="c1"># GET: returns words based on # of syllables or accent index position</span>
<span class="c1"># POST: inserts words/letters but is not used at this time</span>
<div class="viewcode-block" id="getOrCreateWords"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.getOrCreateWords">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/words&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">getOrCreateWords</span><span class="p">():</span>
    <span class="n">req_method</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span>

    <span class="k">if</span> <span class="n">req_method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">upload_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uploadId&#39;</span><span class="p">)</span>
        <span class="n">num_syllables</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numSyllables&#39;</span><span class="p">)</span>
        <span class="n">accent_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accentIndex&#39;</span><span class="p">)</span>


        <span class="n">syllable_filter</span> <span class="o">=</span> <span class="s2">&quot; WHERE num_syllables = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">index_filter</span> <span class="o">=</span> <span class="s2">&quot; AND accent_index = </span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="n">word_retrieval_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM word&quot;&quot;&quot;</span>

            <span class="n">query_results</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">upload_id</span><span class="p">:</span>
                <span class="n">word_retrieval_query</span> <span class="o">+=</span> <span class="s2">&quot; WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="n">query_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">word_retrieval_query</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">upload_id</span><span class="p">),))</span>
            <span class="k">elif</span> <span class="n">num_syllables</span> <span class="ow">and</span> <span class="n">accent_index</span><span class="p">:</span>
                <span class="n">word_retrieval_query</span> <span class="o">+=</span> <span class="n">syllable_filter</span> <span class="o">+</span> <span class="n">index_filter</span>
                <span class="n">query_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">word_retrieval_query</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_syllables</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">accent_index</span><span class="p">))))</span>
            <span class="k">elif</span> <span class="n">num_syllables</span><span class="p">:</span>
                <span class="n">word_retrieval_query</span> <span class="o">+=</span> <span class="n">syllable_filter</span> <span class="o">+</span> <span class="s2">&quot; ORDER BY accent_index&quot;</span>
                <span class="n">query_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">word_retrieval_query</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_syllables</span><span class="p">),))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">word_retrieval_query</span><span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;isSuccessful&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">query_results</span><span class="p">:</span>
                <span class="n">letters_retrieval_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT * FROM letter WHERE word_id = </span><span class="si">%s</span><span class="s2"> ORDER BY order_index&quot;&quot;&quot;</span>
                <span class="n">letters</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">letters_query_results</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">letters_retrieval_query</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),))</span>

                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">letters_query_results</span><span class="p">:</span>
                    <span class="n">letters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;syllable&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">&quot;t0&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                            <span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                            <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                            <span class="s2">&quot;isManualPitch&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                            <span class="s2">&quot;isWordSep&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                <span class="n">response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;uploadId&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;numSyllables&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s2">&quot;accentIndex&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="s2">&quot;minPitch&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                        <span class="s2">&quot;maxPitch&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                        <span class="s2">&quot;imagePath&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                        <span class="s2">&quot;letters&quot;</span><span class="p">:</span> <span class="n">letters</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">req_method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>

        <span class="c1"># Check if first layer of schema has all mandatory fields</span>
        <span class="n">body_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;uploadId&quot;</span><span class="p">,</span> <span class="s2">&quot;minPitch&quot;</span><span class="p">,</span> <span class="s2">&quot;maxPitch&quot;</span><span class="p">,</span> <span class="s2">&quot;letters&quot;</span><span class="p">,</span> <span class="s2">&quot;creator&quot;</span><span class="p">,</span> <span class="s2">&quot;imagePath&quot;</span><span class="p">,</span> <span class="s2">&quot;accentIndex&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">body_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;isSuccessful&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;1 or more required request body fields missing&quot;</span><span class="p">},</span> <span class="mi">400</span>

        <span class="c1"># Check if all letters contain all required schema fields</span>
        <span class="n">letter_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;syllable&quot;</span><span class="p">,</span> <span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="s2">&quot;t1&quot;</span><span class="p">,</span> <span class="s2">&quot;pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;isManualPitch&quot;</span><span class="p">,</span> <span class="s2">&quot;isWordSep&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;letters&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">letter_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">letter</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;isSuccessful&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;1 or more required letters are missing 1 or more required fields&quot;</span><span class="p">},</span> <span class="mi">400</span>

        <span class="n">num_syllables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;letters&quot;</span><span class="p">])</span>


        <span class="k">with</span> <span class="n">Postgres</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>

            <span class="c1"># Create a new Word record for this word</span>
            <span class="n">word_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                    INSERT INTO word(</span>
<span class="s2">                                                        id, user_id, num_syllables, accent_index, min_pitch, max_pitch, </span>
<span class="s2">                                                        image_path</span>
<span class="s2">                                                    )</span>
<span class="s2">                                    VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                                &quot;&quot;&quot;</span>

            <span class="n">word_record_to_insert</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">body</span><span class="p">[</span><span class="s2">&quot;uploadId&quot;</span><span class="p">],</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">],</span> <span class="n">num_syllables</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;accentIndex&quot;</span><span class="p">],</span>
                                        <span class="n">body</span><span class="p">[</span><span class="s2">&quot;minPitch&quot;</span><span class="p">],</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;maxPitch&quot;</span><span class="p">],</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;imagePath&quot;</span><span class="p">]</span>
                                    <span class="p">)</span>

            <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">word_insert_query</span><span class="p">,</span> <span class="n">word_record_to_insert</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="n">word_id</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;uploadId&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">order_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;letters&quot;</span><span class="p">])):</span>
                <span class="n">letter</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;letters&quot;</span><span class="p">][</span><span class="n">order_index</span><span class="p">]</span>
                <span class="n">letter_insert_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                            INSERT INTO letter</span>
<span class="s2">                                                        (</span>
<span class="s2">                                                            id, syllable, word_id, t0, t1, pitch, is_manual_pitch, </span>
<span class="s2">                                                            is_word_sep, order_index</span>
<span class="s2">                                                        )</span>
<span class="s2">                                            VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                                      &quot;&quot;&quot;</span>

                <span class="n">letter_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
                <span class="n">letter_record_to_insert</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">letter_id</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="s2">&quot;syllable&quot;</span><span class="p">],</span> <span class="n">word_id</span><span class="p">,</span> <span class="n">letter</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">],</span> <span class="n">letter</span><span class="p">[</span><span class="s2">&quot;t1&quot;</span><span class="p">],</span> <span class="n">letter</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">],</span>
                                            <span class="n">letter</span><span class="p">[</span><span class="s2">&quot;isManualPitch&quot;</span><span class="p">],</span> <span class="n">letter</span><span class="p">[</span><span class="s2">&quot;isWordSep&quot;</span><span class="p">],</span> <span class="n">order_index</span>
                                          <span class="p">)</span>

                <span class="n">connection</span><span class="o">.</span><span class="n">execute_insert_query</span><span class="p">(</span><span class="n">letter_insert_query</span><span class="p">,</span> <span class="n">letter_record_to_insert</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;isSuccessful&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word_id</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">],</span> <span class="s1">&#39;numSyllables&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;letters&quot;</span><span class="p">])})</span></div>

<span class="c1">#PELDA </span>
<div class="viewcode-block" id="drawSound"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.drawSound">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/draw-sound/&lt;string:upload_id&gt;.png/image&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">drawSound</span><span class="p">(</span><span class="n">upload_id</span><span class="p">):</span>
    <span class="n">sound_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;SOUNDS&quot;</span><span class="p">],</span> <span class="n">upload_id</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** scripts path ****&quot;</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span><span class="p">)</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;getBounds&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  <span class="c1"># Split output into an array</span>

    <span class="c1"># Get last modified time of the sound file</span>
    <span class="c1"># Should think about either changing the service name,</span>
    <span class="c1"># or obtaining last modified time using a different service</span>
    <span class="n">lastModifiedTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">sound_path</span><span class="p">))</span>

    <span class="c1"># Get URL parameters</span>
    <span class="n">showSpectrogram</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spectrogram&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showPitch</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pitch&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showIntensity</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intensity&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showFormants</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formants&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showPulses</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pulses&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>

    <span class="c1"># Script file</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;drawSpectrogram&quot;</span>

    <span class="c1"># Parameters to the script</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">upload_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
             <span class="n">showSpectrogram</span><span class="p">,</span> <span class="n">showPitch</span><span class="p">,</span> <span class="n">showIntensity</span><span class="p">,</span> <span class="n">showFormants</span><span class="p">,</span> <span class="n">showPulses</span><span class="p">,</span>
              <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_images_dir</span><span class="p">]</span>

    <span class="c1"># Image name will be a combination of relevant params joined by a period.</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_images_dir</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
    
    <span class="c1"># Add image name to params list</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">praat</span><span class="o">.</span><span class="n">_images_dir</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_ENV&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;development&quot;</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;metilda/&quot;</span> <span class="o">+</span> <span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;src/metilda/&quot;</span> <span class="o">+</span> <span class="n">image</span><span class="p">)</span>

    <span class="c1"># If image does not exist, run script</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Draw Image with time: &quot;</span> <span class="o">+</span> <span class="n">image_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
        <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">resizeImage</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>

    <span class="c1"># Image should be available now, generated or cached</span>
    <span class="c1">#os.remove(image) // Should these images be removed at some point or left in Cache?</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="drawSoundWithTime"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.drawSoundWithTime">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/draw-sound/&lt;sound&gt;/&lt;startTime&gt;/&lt;endTime&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">drawSoundWithTime</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
    <span class="c1"># Get URL parameters</span>
    <span class="n">showSpectrogram</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spectrogram&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showPitch</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pitch&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showIntensity</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intensity&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showFormants</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formants&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">showPulses</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pulses&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;1&#39;</span>

    <span class="c1"># Script file</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;drawSpectrogram&quot;</span><span class="p">;</span>

    <span class="c1"># Parameters to the script</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span>
             <span class="n">showSpectrogram</span><span class="p">,</span> <span class="n">showPitch</span><span class="p">,</span> <span class="n">showIntensity</span><span class="p">,</span> <span class="n">showFormants</span><span class="p">,</span> <span class="n">showPulses</span><span class="p">,</span> 
             <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_images_dir</span><span class="p">];</span>

    <span class="c1"># Image name will be a combination of relevant params joined by a period.</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_images_dir</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>

    <span class="c1"># Add image name to params list</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">praat</span><span class="o">.</span><span class="n">_images_dir</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASK_ENV&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;development&quot;</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;metilda/&quot;</span> <span class="o">+</span> <span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;src/metilda/&quot;</span> <span class="o">+</span> <span class="n">image</span><span class="p">)</span>
        
    <span class="c1"># If image does not exist, run script</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Draw Image with time: &quot;</span> <span class="o">+</span> <span class="n">image_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
        <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">resizeImage</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>

    <span class="c1"># Image should be available now, generated or cached</span>
    <span class="c1">#os.remove(image)</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="getBounds"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.getBounds">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get-bounds/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">getBounds</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;getBounds&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="c1"># Split output into an array</span>

    <span class="c1"># Create JSON object to return</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span></div>

<div class="viewcode-block" id="getEnergy"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.getEnergy">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get-energy/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">getEnergy</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;getEnergy&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span> </div>

<div class="viewcode-block" id="countVoicedFrames"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.countVoicedFrames">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pitch/count-voiced-frames/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">countVoicedFrames</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;countVoicedFrames&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;voicedFrames&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="pitchValueAtTime"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.pitchValueAtTime">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pitch/value-at-time/&lt;sound&gt;/&lt;time&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">pitchValueAtTime</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;pitchValueAtTime&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;pitchValueAtTime&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="pitchValueInFrame"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.pitchValueInFrame">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pitch/value-in-frame/&lt;sound&gt;/&lt;frame&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">pitchValueInFrame</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;pitchValueInFrame&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;pitchValueInFrame&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span> </div>

<div class="viewcode-block" id="spectrumFrequencyBounds"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.spectrumFrequencyBounds">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/spectrum/get-bounds/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">spectrumFrequencyBounds</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="c1"># Script file</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;spectrumFreqBounds&quot;</span>

    <span class="c1"># Run script and get output</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])</span>

    <span class="c1"># Split output into an array</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># Create JSON object to return</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
       <span class="s2">&quot;lowFrequency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
       <span class="s2">&quot;highFrequency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span></div>

<div class="viewcode-block" id="intensityBounds"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.intensityBounds">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/intensity/get-bounds/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">intensityBounds</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="c1"># Patht to script</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;intensityBounds&quot;</span>

    <span class="c1"># Run script</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])</span>

    <span class="c1"># Split output into an array</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># Create JSON object to return</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
       <span class="s2">&quot;minIntensity&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
       <span class="s2">&quot;maxIntensity&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
       <span class="s2">&quot;meanIntensity&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span> </div>

<div class="viewcode-block" id="formantFrameCount"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.formantFrameCount">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/formant/number-of-frames/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">formantFrameCount</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;formantFrameCount&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;noOfFrames&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="formantCountAtFrame"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.formantCountAtFrame">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/formant/number-of-formants/&lt;sound&gt;/&lt;frame&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">formantCountAtFrame</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;formantCount&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;noOfFormants&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="formantValueAtTime"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.formantValueAtTime">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/formant/value-at-time/&lt;sound&gt;/&lt;formantNumber&gt;/&lt;time&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">formantValueAtTime</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">formantNumber</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;formantValueAtTime&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;formantValueAtTime&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">formantNumber</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="harmonicityGetMin"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.harmonicityGetMin">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/harmonicity/get-min/&lt;sound&gt;/&lt;start&gt;/&lt;end&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">harmonicityGetMin</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;harmonicityGetMin&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;minHarmonicity&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="harmonicityGetMax"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.harmonicityGetMax">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/harmonicity/get-max/&lt;sound&gt;/&lt;start&gt;/&lt;end&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">harmonicityGetMax</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;harmonicityGetMax&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;maxHarmonicity&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="harmonicityValueAtTime"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.harmonicityValueAtTime">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/harmonicity/value-at-time/&lt;sound&gt;/&lt;time&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">harmonicityValueAtTime</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;harmonicityGetValueAtTime&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;harmonicityValueAtTime&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="pointProcessGetNumPeriods"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.pointProcessGetNumPeriods">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pointprocess/number-of-periods/&lt;sound&gt;/&lt;start&gt;/&lt;end&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">pointProcessGetNumPeriods</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;pointProcessGetNumPeriods&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;noOfPeriods&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="pointProcessGetNumPoints"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.pointProcessGetNumPoints">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pointprocess/number-of-points/&lt;sound&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">pointProcessGetNumPoints</span><span class="p">(</span><span class="n">sound</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;pointProcessGetNumPoints&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;noOfPoints&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="pointProcessGetJitter"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.pointProcessGetJitter">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pointprocess/get-jitter/&lt;sound&gt;/&lt;start&gt;/&lt;end&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">pointProcessGetJitter</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_scripts_dir</span> <span class="o">+</span> <span class="s2">&quot;pointProcessGetJitter&quot;</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;localJitter&quot;</span><span class="p">:</span> <span class="n">praat</span><span class="o">.</span><span class="n">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="p">[</span><span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span><span class="p">])})</span></div>

<div class="viewcode-block" id="annotationTimeSelection"><a class="viewcode-back" href="../../../metilda.controllers.html#metilda.controllers.pitch_art_wizard.annotationTimeSelection">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/annotation/&lt;eaffilename&gt;/&lt;sound&gt;/&lt;start&gt;/&lt;end&gt;/&lt;text0&gt;/&lt;text1&gt;/&lt;text2&gt;/&lt;text3&gt;/&lt;text4&gt;/&lt;text5&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">annotationTimeSelection</span><span class="p">(</span><span class="n">eaffilename</span><span class="p">,</span> <span class="n">sound</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">text0</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> <span class="n">text3</span><span class="p">,</span> <span class="n">text4</span><span class="p">,</span> <span class="n">text5</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sound</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">nameoffile</span> <span class="o">=</span> <span class="n">eaffilename</span>

    <span class="k">if</span> <span class="n">text0</span> <span class="o">==</span> <span class="s2">&quot;EMPTY&quot;</span><span class="p">:</span>
        <span class="n">text0</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text1</span> <span class="o">==</span> <span class="s2">&quot;EMPTY&quot;</span><span class="p">:</span>
        <span class="n">text1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text2</span> <span class="o">==</span> <span class="s2">&quot;EMPTY&quot;</span><span class="p">:</span>
        <span class="n">text2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text3</span> <span class="o">==</span> <span class="s2">&quot;EMPTY&quot;</span><span class="p">:</span>
        <span class="n">text3</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text4</span> <span class="o">==</span> <span class="s2">&quot;EMPTY&quot;</span><span class="p">:</span>
        <span class="n">text4</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text5</span> <span class="o">==</span> <span class="s2">&quot;EMPTY&quot;</span><span class="p">:</span>
        <span class="n">text5</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1">#Create a new EAF file</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_eaf_dir</span> <span class="o">+</span> <span class="n">nameoffile</span> <span class="o">+</span> <span class="s2">&quot;.eaf&quot;</span>
    <span class="n">startTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">)))</span>
    <span class="n">endTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">end</span><span class="p">)))</span>

    <span class="c1"># Initialize the elan file</span>
    <span class="n">eafob</span> <span class="o">=</span> <span class="n">pympi</span><span class="o">.</span><span class="n">Elan</span><span class="o">.</span><span class="n">Eaf</span><span class="p">()</span>

    <span class="c1">#Add linguistic type constraint - right now just one - Time_Subdivision</span>
    <span class="n">ltype</span> <span class="o">=</span> <span class="s2">&quot;TimeSubdivision-lt&quot;</span>
    <span class="n">ltcon</span> <span class="o">=</span> <span class="s2">&quot;Time_Subdivision&quot;</span>

    <span class="c1">#prep variables for media descriptor</span>
    <span class="n">soundpath</span> <span class="o">=</span> <span class="n">praat</span><span class="o">.</span><span class="n">_sounds_dir</span> <span class="o">+</span> <span class="n">sound</span>
    <span class="n">soundpath_url</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">soundpath</span><span class="p">)</span>
    <span class="n">relpath</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span> <span class="o">+</span> <span class="n">sound</span>
    <span class="n">mimetype</span> <span class="o">=</span> <span class="s2">&quot;audio/&quot;</span> <span class="o">+</span> <span class="n">sound</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">sound</span><span class="p">)]</span>

    <span class="c1">#set media descriptor</span>
    <span class="k">if</span><span class="p">(</span><span class="n">soundpath</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_linked_file</span><span class="p">(</span><span class="n">soundpath_url</span><span class="p">,</span> <span class="n">relpath</span><span class="p">,</span> <span class="n">mimetype</span><span class="p">)</span> 

    <span class="n">defaulttier</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">tier1</span> <span class="o">=</span> <span class="s2">&quot;Tier1&quot;</span>
    <span class="n">tier2</span> <span class="o">=</span> <span class="s2">&quot;Tier2&quot;</span> 
    <span class="n">tier3</span> <span class="o">=</span> <span class="s2">&quot;Tier3&quot;</span>
    <span class="n">tier4</span> <span class="o">=</span> <span class="s2">&quot;Tier4&quot;</span>
    <span class="n">tier5</span> <span class="o">=</span> <span class="s2">&quot;Tier5&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">text0</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span> <span class="ow">and</span> <span class="n">text0</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">defaulttier</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">text0</span><span class="p">)</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_linguistic_type</span><span class="p">(</span><span class="n">ltype</span><span class="p">,</span> <span class="n">ltcon</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">text1</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span> <span class="ow">and</span> <span class="n">text1</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_tier</span><span class="p">(</span><span class="n">tier1</span><span class="p">,</span> <span class="n">ltype</span><span class="p">)</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">tier1</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">text1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">text2</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span> <span class="ow">and</span> <span class="n">text2</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_tier</span><span class="p">(</span><span class="n">tier2</span><span class="p">,</span> <span class="n">ltype</span><span class="p">)</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">tier2</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">text3</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span> <span class="ow">and</span> <span class="n">text3</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_tier</span><span class="p">(</span><span class="n">tier3</span><span class="p">,</span> <span class="n">ltype</span><span class="p">)</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">tier3</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">text3</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">text4</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span> <span class="ow">and</span> <span class="n">text4</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_tier</span><span class="p">(</span><span class="n">tier4</span><span class="p">,</span> <span class="n">ltype</span><span class="p">)</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">tier4</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">text4</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">text5</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span> <span class="ow">and</span> <span class="n">text5</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_tier</span><span class="p">(</span><span class="n">tier5</span><span class="p">,</span> <span class="n">ltype</span><span class="p">)</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">tier5</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">text5</span><span class="p">)</span>

    <span class="c1">#Write the object to a file</span>
    <span class="k">if</span><span class="p">(</span><span class="n">filepath</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">eafob</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      
    <span class="n">xmlObject</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">eafstring</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">xmlObject</span><span class="p">,</span> <span class="n">pretty_print</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eafstring</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Dr Chen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>